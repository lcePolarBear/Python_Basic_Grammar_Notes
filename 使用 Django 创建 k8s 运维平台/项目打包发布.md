# 项目打包发布
### 导出依赖模块列表
```bash
pip3 freeze > requirements.txt
```
### 进行发布环境初始化
- 关闭debug模式和白名单,修改数据库为 Mysql
```python
# devops/__init__.py
import pymysql
pymysql.install_as_MySQLdb()

# vi devops/settings.py
DEBUG = False   # 调试模式
ALLOWED_HOSTS = ['*' ]  # 白名单，只允许列表中的ip访问，*代表所有

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'k8s',
        'USER': 'root',
        'PASSWORD': '',
        'HOST': '',
        'PORT': '3306',
    }
}
```
- 安装依赖模块列表
```bash
pip3 install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple
```
### 使用 uwsgi 发布 web
- 安装 uwsgi
```python
pip3 install uwsgi -i https://mirrors.aliyun.com/pypi/simple
```
- 在项目文件夹创建 uwsgi 配置文件
```ini
# vi uwsgi.ini
[uwsgi]
# 项目目录
chdir = /opt/devops
				
# 指定sock的文件路径
socket = /opt/devops/uwsgi/uwsgi.sock
# 指定监听端口，使用 nginx 代理
# http = 0.0.0.0:8080

# 静态资源
static-map = /static=/opt/devops/static

# wsgi文件（django入口）
wsgi-file=devops/wsgi.py

# 进程个数
processes = 4 

# 指定项目的应用
# module = devops.wsgi

# 进程pid
pidfile = /opt/devops/uwsgi/uwsgi.pid

# 日志路径
daemonize = /opt/devops/uwsgi/uwsgi.log
```
```ini
# vi /usr/lib/systemd/system/uwsgi.service

[Unit]
Description=HTTP Interface Server

[Service]
Type=forking
ExecStart=/usr/local/bin/uwsgi --ini /opt/devops/uwsgi/uwsgi.ini
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```
- 启用 uwsgi 服务
```python
systemctl daemon-reload
systemctl start uwsgi
systemctl enable uwsgi
```
- 使用 nginx 代理加速访问静态内容
```conf
# /etc/nginx/nginx.conf
server {
        listen       80 default_server;
        server_name  _;

        location / {
           include     uwsgi_params;  # 导入模块用于与uwsgi通信
           uwsgi_pass unix:/opt/devops/uwsgi/uwsgi.sock; 
        }
        # 静态文件目录
        location /static {
           alias /opt/devops/static;
        }
}
```
启动 nginx 并测试访问
```bash
systemctl start nginx

http://127.0.0.1:80/
```
### 实现发布环境下的 websocket 连接
- 部署 daphne（处理websocket请求），使用 asgi 服务器来处理 websocket 请求
```bash
pip3 install daphne -i https://mirrors.aliyun.com/pypi/simple
```
```python
# /devops/asgi.py
import os
import django
from channels.routing import get_default_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'devops.settings')
django.setup()
application = get_default_application()
```
- 启动 daphne 服务
```ini
[Unit]
Description=Django Websocket Server

[Service]
WorkingDirectory=/opt/devops
ExecStart=/usr/local/bin/daphne devops.asgi:application -b 127.0.0.1 -p 8000
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```
```bash
systemctl daemon-reload
systemctl start daphne
systemctl enable daphne
```
- Nginx 配置文件增加代理
```ini
server {
    listen       80 default_server;
    server_name  _;

    location / {
        include     uwsgi_params;  # 导入模块用于与uwsgi通信
        uwsgi_pass unix:/opt/devops/uwsgi/uwsgi.sock;
    }
    location /workload/terminal {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    # 静态文件目录
    location /static {
        alias /opt/devops/static;
    }
}

```
- 重启 nginx ，并测试 websocket 能否访问
```bash
systemctl restart nginx
```